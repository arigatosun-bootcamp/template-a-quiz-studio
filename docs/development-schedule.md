# JapanMaster 開発スケジュール

> 要件定義書・機能要件書・API設計書・コンポーネント一覧を基に、Day単位で作業を分割した開発計画。
> 作業の依存関係（インフラ → 認証 → コア機能 → 表示系 → 仕上げ）を考慮して順序を決定している。

---

## 進捗状況サマリー

| Day | 状態 | 概要 |
|-----|------|------|
| Day 1 | **一部完了** | インフラ構築 + 認証機能 |
| Day 2 | 未着手 | クイズ生成・回答のコア機能 |
| Day 3 | 未着手 | クイズUI + 結果画面 |
| Day 4 | 未着手 | 履歴・達成状況・日本地図 |
| Day 5 | 未着手 | 設定・共通UI・テスト・デプロイ |

---

## マイルストーン

| マイルストーン | 達成タイミング | 確認できること |
|--------------|---------------|---------------|
| **MS1: 認証基盤の完成** | Day 1 終了時 | メール & Google でログイン/新規登録ができ、認証ガードが動作する |
| **MS2: クイズが遊べる** | Day 2 終了時 | ジャンル・難易度を選んでクイズ5問を生成し、回答を保存できる（API レベル） |
| **MS3: クイズ体験の完成** | Day 3 終了時 | 画面上でクイズを遊び、結果画面まで一連のフローが動作する |
| **MS4: データ閲覧の完成** | Day 4 終了時 | 回答履歴・達成状況・日本地図の色付けがすべて閲覧できる |
| **MS5: 本番リリース可能** | Day 5 終了時 | 全機能が動作し、テスト通過、Vercel にデプロイ完了 |

---

## Day 1: インフラ構築 + 認証機能

### ゴール

> Supabase のDB・認証基盤が整い、ログイン/新規登録/パスワードリセットが動作する状態にする

### 作業内容

#### 1-1. DB設計 + Supabase環境構築（完了済み）

- [x] Supabase プロジェクトの作成・接続設定
- [x] テーブル作成（users, quizzes, answers, quiz_sessions, prefecture_progress）
- [x] RLS（Row Level Security）ポリシーの設定
- [x] CASCADE削除の設定
- [x] `.env.local` に環境変数を設定
- [x] Supabase クライアントライブラリのインストール・初期化

**対応Issue:** #16（PR #18 作成済み）

#### 1-2. 認証機能の実装（未着手）

- [ ] Supabase Auth の設定（メール認証 + Google OAuth）
- [ ] 認証レイアウト `AuthLayout`（L3）の実装
- [ ] ログイン画面（`/login`）の実装
  - Input（U2）、PasswordInput（U3）、Button（U1）、GoogleLoginButton（U15）
  - メール & パスワードログイン処理
  - Google OAuth ログイン処理
  - バリデーション + ErrorMessage（U10）
- [ ] 新規登録画面（`/register`）の実装
  - Checkbox（U4）（利用規約同意）
  - メール確認フローの実装
  - `users` テーブルへの自動登録（トリガーまたはクライアント側）
- [ ] パスワードリセット画面（`/reset-password`）の実装
  - リセットメール送信 + パスワード再設定画面
- [ ] 認証ガード（ミドルウェア）の実装
  - 未ログイン時のリダイレクト
  - ログイン済みユーザーの認証画面アクセス防止
- [ ] 共通UIコンポーネントの実装（認証画面で使うもの）
  - Button（U1）、Input（U2）、PasswordInput（U3）
  - Checkbox（U4）、ErrorMessage（U10）、GoogleLoginButton（U15）
  - Toast（U11）

**対応Issue:** #17

### 完了条件

- [x] Supabase にテーブルが作成され、RLS が有効になっている
- [ ] メール & パスワードで新規登録 → メール確認 → ログインができる
- [ ] Google アカウントでログイン/登録ができる
- [ ] パスワードリセットメールが送信され、再設定ができる
- [ ] 未ログイン時にトップ画面にアクセスするとログイン画面にリダイレクトされる
- [ ] ログイン済みでログイン画面にアクセスするとトップ画面にリダイレクトされる

---

## Day 2: クイズ生成・回答のコア機能（API + ロジック）

### ゴール

> Gemini API を使ったクイズ生成、回答保存、セッション管理の API が全て動作する状態にする

### 作業内容

#### 2-1. 共通ライブラリの整備

- [ ] 認証ヘルパー（`lib/auth.ts`）の実装
- [ ] APIエラーレスポンスヘルパー（`lib/api-error.ts`）の実装
- [ ] 定数定義（`lib/constants.ts`）: ジャンル、難易度、日次上限、都道府県リスト
- [ ] 都道府県リスト（`lib/prefectures.ts`）の定義
- [ ] Gemini API クライアントの設定

#### 2-2. クイズ生成 API の実装

- [ ] `POST /api/quiz/generate` の実装
  - 利用上限チェック（1日20回）
  - 出題県の決定ロジック（未正解の県を優先）
  - Gemini API へのプロンプト送信
  - レスポンスのパース・バリデーション（構造化 → バリデーション → 再試行 → 失敗ログ）
  - リトライ処理（最大3回、2秒 → 4秒の待機）
  - `quiz_sessions` + `quizzes` テーブルへの保存

#### 2-3. 回答・セッション完了 API の実装

- [ ] `POST /api/quiz/answer` の実装
  - 回答の保存、正解判定、解説の返却
  - 重複回答の防止（409エラー）
- [ ] `POST /api/quiz/complete` の実装
  - スコア集計 + `quiz_sessions` の更新
  - `prefecture_progress` の更新（難易度の比較ロジック含む）
- [ ] `GET /api/quiz/session/[sessionId]` の実装
  - セッション詳細データの取得（結果画面用）

#### 2-4. 補助 API の実装

- [ ] `GET /api/usage/check` の実装（利用回数チェック）
- [ ] `GET /api/history` の実装（回答履歴一覧、ページネーション付き）
- [ ] `GET /api/history/[sessionId]` の実装（履歴詳細）
- [ ] `GET /api/achievement` の実装（達成状況データ取得）
- [ ] `DELETE /api/account` の実装（アカウント削除）

**対応Issue:** 新規作成が必要（例: 「クイズ生成APIの実装」「回答・セッション管理APIの実装」）

### 完了条件

- [ ] Postman / curl 等で全9つの API エンドポイントが正常にレスポンスを返す
- [ ] Gemini API でクイズ5問が生成され、`quizzes` テーブルに保存される
- [ ] 回答を送信すると正解判定が行われ、`answers` テーブルに保存される
- [ ] 5問完了後にスコアと都道府県進捗が正しく更新される
- [ ] 利用上限（20回/日）のチェックが動作する
- [ ] リトライ処理が3回まで正しく動作し、全失敗時にエラーレスポンスが返る

---

## Day 3: クイズUI + 結果画面

### ゴール

> トップ画面でジャンル・難易度を選び、クイズを5問遊び、結果画面まで完了する一連のフローが画面上で動作する

### 作業内容

#### 3-1. アプリ共通レイアウトの実装

- [ ] AppLayout（L4）の実装（ヘッダー + メイン + 広告バナー）
- [ ] Header（L1）の実装（PC版ナビゲーション + ロゴ）
- [ ] MobileMenu（L2）の実装（ハンバーガーメニュー）
- [ ] AdBanner（L5）の実装（広告スペースの枠のみ）
- [ ] PageLoadingBar（U14）の実装（ページ遷移時のプログレスバー）
- [ ] ConfirmDialog（U9）の実装（ログアウト確認用）
- [ ] ログアウト処理の実装

#### 3-2. トップ画面（/）の実装

- [ ] トップ画面ページの作成
- [ ] StepSelector（Q4）の実装
  - GenreSelector（Q1）: ジャンル選択ボタン群
  - DifficultySelector（Q2）: 難易度選択ボタン群
  - QuizStartButton（Q3）: ゲームスタートボタン
- [ ] DailyLimitNotice（Q22）の実装（利用上限通知）
- [ ] トップ画面の日本地図エリア（プレースホルダー、Day 4 で完成）

#### 3-3. クイズ画面（/quiz）の実装

- [ ] QuizLoading（Q12）の実装（生成中ローディング）
- [ ] QuizError（Q13）の実装（生成失敗エラー + 再試行ボタン）
- [ ] QuizContainer（Q11）の実装（クイズ進行管理）
  - QuizProgress（Q5）: 進捗表示「問題 1/5」
  - QuizQuestion（Q6）: 問題文表示
  - QuizChoices（Q7）: 3択選択肢
  - AnswerButton（Q8）: 回答確定ボタン
  - AnswerResult（Q9）: 正解/不正解 + 解説表示
  - QuizNextButton（Q10）: 次の問題へ / 結果を見るボタン
- [ ] クイズ画面のアクセス制御（ジャンル・難易度未選択時のリダイレクト）

#### 3-4. 結果画面（/result）の実装

- [ ] 結果画面ページの作成
- [ ] ResultScore（Q14）の実装（正解数 + メッセージ）
- [ ] ResultQuizList（Q15）+ ResultQuizItem（Q16）の実装（全問一覧）
- [ ] ResultActions（Q17）の実装（もう一度 + トップに戻る）
- [ ] ResultAdSpace（Q18）の実装（広告スペース）

**対応Issue:** 新規作成が必要（例: 「トップ画面の実装」「クイズ画面の実装」「結果画面の実装」）

### 完了条件

- [ ] トップ画面でジャンル → 難易度 → ゲームスタートの3ステップ操作ができる
- [ ] ゲームスタートでクイズ画面に遷移し、ローディング後に1問目が表示される
- [ ] 選択肢を選んで「回答する」を押すと正解/不正解 + 解説が表示される
- [ ] 5問すべて回答後、「結果を見る」で結果画面に遷移する
- [ ] 結果画面で正解数・メッセージ・全問一覧が正しく表示される
- [ ] 「同じ条件でもう一度」で再度クイズが開始できる
- [ ] ヘッダーのナビゲーションが動作する（PC / スマホ両方）
- [ ] ログアウト時に確認ダイアログが表示され、ログイン画面に遷移する

---

## Day 4: 履歴・達成状況・日本地図

### ゴール

> 回答履歴の閲覧、達成状況の統計表示、SVG日本地図の色付けが全て動作する状態にする

### 作業内容

#### 4-1. 回答履歴画面（/history）の実装

- [ ] 回答履歴画面ページの作成
- [ ] HistorySessionList（Q19）の実装（セッション一覧）
- [ ] HistorySessionCard（Q20）の実装（折りたたみ対応カード）
- [ ] HistoryQuizDetail（Q21）の実装（展開時の問題詳細）
- [ ] Pagination（U8）の実装（ページネーション、1ページ10件）
- [ ] SkeletonLoader（U6）の実装（データ読み込み中のスケルトン表示）
- [ ] EmptyState（U12）の実装（データなし時のメッセージ）
- [ ] トップ画面下部の「回答履歴を見る」ボタン追加

#### 4-2. 達成状況画面（/achievement）の実装

- [ ] 達成状況画面ページの作成
- [ ] AchievementSummary（M4）の実装（制覇状況 + 進捗バー）
- [ ] DifficultyProgress（M5）の実装（難易度別の制覇数）
- [ ] OverallStats（M6）の実装（総回答数 + 全体正答率）
- [ ] GenreStats（M7）の実装（ジャンル別正答率）
- [ ] ProgressBar（U7）の実装（各種進捗バー）

#### 4-3. SVG日本地図の実装

- [ ] SVG日本地図データの準備（47都道府県のパスデータ）
- [ ] JapanMap（M1）の実装（47都道府県の色制御）
- [ ] PrefecturePath（M2）の実装（個別の都道府県パス）
- [ ] MapLegend（M3）の実装（色の凡例表示）
- [ ] トップ画面への地図配置（タップで達成状況画面へ遷移）
- [ ] 達成状況画面への地図配置

**対応Issue:** 新規作成が必要（例: 「回答履歴画面の実装」「達成状況画面の実装」「SVG日本地図の実装」）

### 完了条件

- [ ] 回答履歴画面でセッション一覧が新しい順に表示される
- [ ] 各セッションをタップで展開し、全問題と解説が閲覧できる
- [ ] ページネーションで10件ずつ切り替えができる
- [ ] 達成状況画面で制覇率・難易度別進捗・正答率・ジャンル別正答率が表示される
- [ ] 日本地図で正解済みの都道府県に色がついている（初級=薄緑、中級=緑、上級=深緑）
- [ ] トップ画面の地図をタップで達成状況画面に遷移する
- [ ] データがない場合に適切なメッセージが表示される

---

## Day 5: 設定・共通UI・テスト・デプロイ

### ゴール

> 全機能を完成させ、テストを通し、Vercel にデプロイして本番公開できる状態にする

### 作業内容

#### 5-1. 設定画面（/settings）の実装

- [ ] 設定画面ページの作成
- [ ] パスワード変更機能の実装（バリデーション付き）
- [ ] アカウント削除機能の実装
  - ConfirmDialog（U9）による確認
  - `DELETE /api/account` の呼び出し
  - CASCADE削除の動作確認
- [ ] ログイン画面へのリダイレクト

#### 5-2. エラー画面・静的ページの実装

- [ ] ErrorPage（U13）の実装
- [ ] 404 ページの作成（`not-found.tsx`）
- [ ] 500 エラーページの作成（`error.tsx`）
- [ ] プライバシーポリシーページの作成
- [ ] 利用規約ページの作成
- [ ] LoadingSpinner（U5）の最終調整

#### 5-3. レスポンシブデザインの調整

- [ ] 全画面のスマートフォン表示確認・修正（767px以下）
- [ ] 全画面のPC表示確認・修正（768px以上）
- [ ] タブレット表示の確認

#### 5-4. テスト

- [ ] 全APIエンドポイントのユニットテスト（Vitest）
- [ ] 認証フローの結合テスト
- [ ] クイズフロー（生成 → 回答 → 完了）の結合テスト
- [ ] `npm run lint` が通ることを確認
- [ ] `npm run build` が通ることを確認
- [ ] `npm test` が全件通ることを確認

#### 5-5. デプロイ

- [ ] Vercel プロジェクトの作成・接続
- [ ] 環境変数の設定（Supabase URL / Key, Gemini API Key）
- [ ] 本番ビルド・デプロイの実行
- [ ] 本番環境での動作確認
  - 認証フロー（新規登録 → メール確認 → ログイン）
  - クイズフロー（ジャンル選択 → クイズ → 結果）
  - 各画面の表示確認

**対応Issue:** 新規作成が必要（例: 「設定画面の実装」「エラー画面・静的ページの実装」「テスト・デプロイ」）

### 完了条件

- [ ] 設定画面でパスワード変更ができる
- [ ] アカウント削除が正しく動作し、全関連データが削除される
- [ ] 404 / 500 エラー画面が正しく表示される
- [ ] プライバシーポリシー・利用規約ページが閲覧できる
- [ ] 全画面がPC・スマートフォンで正しく表示される
- [ ] `npm run lint` / `npm run build` / `npm test` がすべて通る
- [ ] Vercel にデプロイされ、本番URLからアプリが利用できる

---

## Day別の作業量見積もり

| Day | 画面数 | API数 | コンポーネント数 | 主な作業内容 |
|-----|--------|-------|-----------------|-------------|
| Day 1 | 3画面 | 0 | 8個（UI基盤） | DB構築 + 認証3画面 + 認証ガード |
| Day 2 | 0画面 | 9 API | 0個 | 全APIエンドポイント + 共通ライブラリ |
| Day 3 | 3画面 | 0 | 22個（レイアウト5 + クイズ系17） | トップ + クイズ + 結果画面 |
| Day 4 | 2画面 | 0 | 14個（履歴4 + 地図7 + UI3） | 履歴 + 達成状況 + 日本地図 |
| Day 5 | 1画面 + 静的4P | 0 | 5個 + テスト + デプロイ | 設定 + エラー + テスト + デプロイ |

---

## GitHub Issue 対応表

| Day | Issue | タイトル | 状態 |
|-----|-------|---------|------|
| Day 1 | #16 | DB設計とSupabase環境構築 | PR作成済み（レビュー待ち） |
| Day 1 | #17 | 認証機能の実装（ログイン/新規登録/PWリセット） | 未着手 |
| Day 2 | 要作成 | クイズ生成APIの実装（Gemini API連携） | - |
| Day 2 | 要作成 | 回答保存・セッション管理APIの実装 | - |
| Day 2 | 要作成 | 履歴・達成状況・利用制限APIの実装 | - |
| Day 3 | 要作成 | 共通レイアウト・ヘッダーの実装 | - |
| Day 3 | 要作成 | トップ画面の実装（ステップ選択UI） | - |
| Day 3 | 要作成 | クイズ画面の実装（5問回答フロー） | - |
| Day 3 | 要作成 | 結果画面の実装 | - |
| Day 4 | 要作成 | 回答履歴画面の実装 | - |
| Day 4 | 要作成 | 達成状況画面の実装 | - |
| Day 4 | 要作成 | SVG日本地図コンポーネントの実装 | - |
| Day 5 | 要作成 | 設定画面の実装（PW変更・アカウント削除） | - |
| Day 5 | 要作成 | エラー画面・プライバシーポリシー・利用規約の実装 | - |
| Day 5 | 要作成 | テスト・レスポンシブ対応・Vercelデプロイ | - |

---

## 注意事項

- **依存関係の厳守**: Day 1（認証）が完了しないと Day 2 以降の API は認証チェックが動作しない。Day 2（API）が完了しないと Day 3 以降の画面からのデータ操作が動作しない。
- **Issue は作業開始前に必ず作成する**: 「要作成」のIssueは、各Dayの作業開始時にGitHubで作成してからブランチを切ること。
- **1 Issue = 1 PR を厳守**: PRが大きくなりすぎる場合は Issue を分割する。
- **テストは Day 5 にまとめているが、各Day で小さなテストを書くことを推奨**: 特にAPI（Day 2）はユニットテストを同時に書くと効率的。
- **`.env.local` は絶対にコミットしない**: 環境変数は Vercel の管理画面から設定する。
