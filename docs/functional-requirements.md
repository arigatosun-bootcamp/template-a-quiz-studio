# JapanMaster 機能要件書

> 要件定義書（requirements.md）の各機能を「どう動かすか」レベルで詳細化した文書。
> 開発者がこの文書を見れば、迷わず実装できることを目指す。

---

## 1. ログイン画面（/login）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| メールアドレス | テキスト入力 | type="email" |
| パスワード | パスワード入力 | type="password"、目のアイコンで表示/非表示切替 |
| 「ログイン」ボタン | ボタン（朱色） | メイン操作 |
| 「Googleでログイン」ボタン | ボタン | Google OAuth |
| 「パスワードを忘れた方はこちら」 | リンク | /reset-password へ遷移 |
| 「新規登録はこちら」 | リンク | /register へ遷移 |

### バリデーション（入力チェック）

| 項目 | ルール | エラーメッセージ |
|------|--------|-----------------|
| メールアドレス | 空欄不可 | 「メールアドレスを入力してください」 |
| メールアドレス | メール形式でない | 「正しいメールアドレスを入力してください」 |
| パスワード | 空欄不可 | 「パスワードを入力してください」 |

### 処理フロー

```
ユーザーがメール・パスワードを入力して「ログイン」を押す
  ↓
入力バリデーション（上記チェック）
  ↓ NGなら → エラーメッセージを該当欄の下に赤字で表示
  ↓ OKなら
ボタンをローディング状態にする（二重送信防止）
  ↓
Supabase Auth: signInWithPassword(email, password) を呼び出す
  ↓
【成功】→ トップ画面（/）にリダイレクト
【失敗】→ 「メールアドレスまたはパスワードが正しくありません」を表示
【メール未確認】→ 「メール認証が完了していません。確認メールをご確認ください」を表示
【アカウントロック】→ 「ログイン試行回数を超えました。しばらく経ってからお試しください」を表示
```

### Googleログイン

```
「Googleでログイン」ボタンを押す
  ↓
Supabase Auth: signInWithOAuth({ provider: 'google' }) を呼び出す
  ↓
Googleの認証画面に遷移 → 認証完了後、アプリに戻る
  ↓
【成功】→ トップ画面（/）にリダイレクト
【失敗】→ 「Googleログインに失敗しました。もう一度お試しください」を表示
```

### アクセス制御

- ログイン済みユーザーがこの画面にアクセスした場合 → トップ画面（/）にリダイレクト

---

## 2. 新規登録画面（/register）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| メールアドレス | テキスト入力 | type="email" |
| パスワード | パスワード入力 | type="password" |
| パスワード（確認） | パスワード入力 | type="password" |
| 「利用規約・プライバシーポリシーに同意する」 | チェックボックス | 未チェックなら登録不可 |
| 「新規登録」ボタン | ボタン（朱色） | メイン操作 |
| 「Googleで登録」ボタン | ボタン | Google OAuth |
| 「ログインはこちら」 | リンク | /login へ遷移 |

### バリデーション

| 項目 | ルール | エラーメッセージ |
|------|--------|-----------------|
| メールアドレス | 空欄不可 | 「メールアドレスを入力してください」 |
| メールアドレス | メール形式でない | 「正しいメールアドレスを入力してください」 |
| パスワード | 空欄不可 | 「パスワードを入力してください」 |
| パスワード | 8文字未満 | 「パスワードは8文字以上で入力してください」 |
| パスワード（確認） | パスワードと不一致 | 「パスワードが一致しません」 |
| 同意チェック | 未チェック | 「利用規約・プライバシーポリシーに同意してください」 |

### 処理フロー

```
ユーザーが情報を入力して「新規登録」を押す
  ↓
入力バリデーション（上記チェック）
  ↓ NGなら → エラーメッセージを該当欄の下に赤字で表示
  ↓ OKなら
ボタンをローディング状態にする（二重送信防止）
  ↓
Supabase Auth: signUp(email, password) を呼び出す
  ↓
【成功】→ 画面に「確認メールを送信しました。メール内のリンクをクリックしてください」を表示
【メール重複】→ 「このメールアドレスは既に登録されています」を表示
【その他エラー】→ 「登録に失敗しました。もう一度お試しください」を表示
```

### メール確認後の流れ

```
ユーザーがメール内のリンクをクリック
  ↓
Supabaseが認証を完了
  ↓
ログイン画面（/login）にリダイレクト
  ↓
「認証が完了しました。ログインしてください」というメッセージを表示
```

### usersテーブルへの登録

```
Supabase Authでユーザー作成成功時
  ↓
public.users テーブルに以下を INSERT:
  - id: auth.users の id（UUID）
  - email: 登録したメールアドレス
  - created_at: 自動（now()）
```

### アクセス制御

- ログイン済みユーザーがこの画面にアクセスした場合 → トップ画面（/）にリダイレクト

---

## 3. パスワードリセット画面（/reset-password）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| メールアドレス | テキスト入力 | type="email" |
| 「リセットメールを送信」ボタン | ボタン（朱色） | メイン操作 |
| 「ログインに戻る」 | リンク | /login へ遷移 |

### バリデーション

| 項目 | ルール | エラーメッセージ |
|------|--------|-----------------|
| メールアドレス | 空欄不可 | 「メールアドレスを入力してください」 |
| メールアドレス | メール形式でない | 「正しいメールアドレスを入力してください」 |

### 処理フロー

```
ユーザーがメールアドレスを入力して「リセットメールを送信」を押す
  ↓
入力バリデーション
  ↓ OKなら
Supabase Auth: resetPasswordForEmail(email) を呼び出す
  ↓
【常に】→ 「パスワードリセット用のメールを送信しました。メールをご確認ください」を表示
  ※ メールが登録されていない場合もセキュリティ上、同じメッセージを表示する
```

### パスワード再設定の流れ

```
ユーザーがメール内のリンクをクリック
  ↓
パスワード再設定画面を表示（新しいパスワード + 確認入力）
  ↓
Supabase Auth: updateUser({ password }) を呼び出す
  ↓
【成功】→ 「パスワードを変更しました」と表示 → ログイン画面へ遷移
【失敗】→ 「パスワードの変更に失敗しました」を表示
```

---

## 4. トップ画面（/）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| 日本地図（SVG） | インタラクティブ地図 | タップで達成状況画面へ遷移 |
| ジャンル選択ボタン×3 | ボタン群 | 地理 / 観光名所 / グルメ |
| 難易度選択ボタン×3 | ボタン群 | 初級 / 中級 / 上級（ジャンル選択後に表示） |
| 「ゲームスタート！」ボタン | ボタン（朱色） | 難易度選択後に表示 |
| 「回答履歴を見る」ボタン | ボタン | /history へ遷移 |

### ステップ選択の動作

```
初期状態: ジャンル選択ボタン×3 のみ表示
  ↓
ステップ1: ジャンルをタップ → 選択したジャンルがハイライト + 難易度ボタン×3 が出現
  ↓
ステップ2: 難易度をタップ → 選択した難易度がハイライト + 「ゲームスタート！」ボタンが出現
  ↓
ステップ3: 「ゲームスタート！」をタップ → クイズ画面へ遷移

※ ジャンルを再タップすると、難易度・スタートボタンがリセットされる
※ 難易度を再タップすると、そのまま変更される
```

### 日本地図の表示

```
画面表示時:
  ↓
Supabaseから prefecture_progress テーブルを取得（WHERE user_id = ログインユーザー）
  ↓
各都道府県の色を決定:
  - レコードなし → グレー（未回答）
  - max_difficulty = 'beginner' → 薄い緑（若草色）
  - max_difficulty = 'intermediate' → 緑（抹茶色）
  - max_difficulty = 'advanced' → 深い緑
  ↓
SVG地図の各都道府県パスに色を適用して表示
```

### AI利用上限チェック

```
「ゲームスタート！」をタップ時:
  ↓
Supabaseから quiz_sessions テーブルを取得
  （WHERE user_id = ログインユーザー AND played_at >= 今日の0:00 JST）
  ↓
件数が20件以上なら → 「本日の利用上限に達しました。明日またお楽しみください」を表示
件数が20件未満なら → クイズ画面（/quiz）へ遷移
```

### アクセス制御

- 未ログインユーザーがアクセスした場合 → ログイン画面（/login）にリダイレクト

---

## 5. クイズ画面（/quiz）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| 進捗表示 | テキスト | 「問題 1 / 5」 |
| 問題文 | テキスト | AI生成された問題 |
| 選択肢×3 | ボタン群 | タップでハイライト |
| 「回答する」ボタン | ボタン（朱色） | 選択肢を選ぶまで非活性 |
| 正解/不正解表示 | テキスト | 回答後に表示 |
| 解説文 | テキスト | 回答後に表示 |
| 「次の問題へ」ボタン | ボタン | 5問目は「結果を見る」に変わる |

### クイズ生成の処理フロー

```
クイズ画面に遷移時:
  ↓
ローディング表示:「クイズを生成中です...」
  ↓
1. quiz_sessions テーブルに新しいセッションを INSERT
   - user_id: ログインユーザーのID
   - genre: 選択したジャンル
   - difficulty: 選択した難易度
   - score: 0（初期値）
  ↓
2. 出題する5県を決定:
   - prefecture_progress から、ログインユーザーが「選択した難易度で未正解」の都道府県を取得
   - その中からランダムに5県を選ぶ
   - 未正解の県が5県未満の場合 → 全47県からランダムに補充
  ↓
3. Claude API に5問の生成をリクエスト:
   - ジャンル、難易度、5県をプロンプトに含める
   - レスポンスをJSON形式でパース
  ↓
4. 生成された5問を quizzes テーブルに INSERT（question_order: 1〜5）
  ↓
5. ローディングを解除 → 1問目を表示
```

### リトライ処理（AI生成失敗時）

```
Claude API 呼び出し
  ↓
【成功】→ 問題を表示
【失敗 or タイムアウト（10秒）】→ 2秒待ってリトライ（2回目）
  ↓
【失敗 or タイムアウト（10秒）】→ 4秒待ってリトライ（3回目）
  ↓
【失敗】→ ローディングを解除
       → 「問題の生成に失敗しました。もう一度お試しください」を表示
       → 「再試行」ボタンを表示
```

### 回答の処理フロー（1問ごと）

```
ユーザーが選択肢をタップ
  ↓
タップした選択肢がハイライトされる（他の選択肢は非ハイライト）
  ↓
「回答する」ボタンが活性化
  ↓
「回答する」をタップ
  ↓
answers テーブルに INSERT:
  - user_id: ログインユーザーのID
  - quiz_id: 現在の問題のID
  - selected_answer: 選んだ選択肢
  - is_correct: 正解かどうか（true/false）
  ↓
正解/不正解を表示:
  【正解】→ 「正解！」+ 正解の選択肢を緑でハイライト + 解説を表示
  【不正解】→ 「不正解」+ 選んだ選択肢を赤でハイライト + 正解の選択肢を緑でハイライト + 解説を表示
  ↓
選択肢ボタンを無効化（変更不可）
  ↓
「次の問題へ」ボタンを表示（5問目なら「結果を見る」ボタン）
```

### 5問終了後の処理

```
5問目の回答完了時:
  ↓
1. quiz_sessions の score を更新（正解数を計算して UPDATE）
  ↓
2. prefecture_progress を更新:
   - 正解した各県について:
     - レコードがなければ INSERT（max_difficulty = 今回の難易度）
     - レコードがあり、今回の難易度の方が上なら UPDATE
     - レコードがあり、今回の難易度の方が下なら何もしない
  ↓
3. 「結果を見る」ボタンを表示
```

### 難易度の順序（比較用）

```
beginner（初級） < intermediate（中級） < advanced（上級）
```

### アクセス制御

- 未ログインユーザー → ログイン画面にリダイレクト
- ジャンル・難易度が未選択（直接URLアクセス）→ トップ画面にリダイレクト

---

## 6. 結果画面（/result）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| 正解数 | テキスト（大きく表示） | 「5問中 3問正解！」 |
| メッセージ | テキスト | 正解数に応じた文言 |
| 全問一覧 | リスト | 各問題の正解/不正解 + 解説 |
| 「同じ条件でもう一度」ボタン | ボタン | 同じジャンル・難易度でクイズ画面へ |
| 「トップに戻る」ボタン | ボタン | / へ遷移 |
| 広告スペース | エリア | フェーズ1では枠のみ確保 |

### メッセージ分岐

| 正解数 | メッセージ |
|--------|-----------|
| 5問 | 「パーフェクト！日本マスターへの道を順調に進んでいます！」 |
| 3〜4問 | 「いい調子です！もう少しで全問正解！」 |
| 1〜2問 | 「次はもっと上を目指しましょう！」 |
| 0問 | 「ドンマイ！挑戦することが大事です！」 |

### 全問一覧の表示

```
各問題を上から順に表示（折りたたみなし）:

問題1（北海道・地理）                    ✅ 正解
Q: 北海道の県庁所在地は？
あなたの回答: 札幌市

問題2（大阪府・グルメ）                  ❌ 不正解
Q: 大阪のB級グルメ「○○焼き」とは？
あなたの回答: お好み焼き
正解: たこ焼き
解説: たこ焼きは大阪発祥の...
```

### 処理フロー

```
画面表示時:
  ↓
直前のセッションIDを使って quizzes + answers テーブルから全データを取得
  ↓
正解数を集計して表示
  ↓
「同じ条件でもう一度」タップ時:
  → AI利用上限をチェック → 上限内ならクイズ画面へ遷移（同じジャンル・難易度で）
```

### アクセス制御

- 未ログインユーザー → ログイン画面にリダイレクト
- セッションIDがない（直接URLアクセス）→ トップ画面にリダイレクト

---

## 7. 回答履歴画面（/history）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| セッション一覧 | リスト | 新しい順に表示 |
| 各セッションの概要 | カード | 日付・ジャンル・難易度・正解数 |
| 折りたたみ展開 | アコーディオン | タップで全問題・解説を表示 |
| ページネーション | ナビゲーション | 1ページ10件 |

### セッション一覧の表示

```
画面表示時:
  ↓
スケルトン表示（枠だけ先に表示）
  ↓
Supabaseから quiz_sessions テーブルを取得:
  - WHERE user_id = ログインユーザー
  - ORDER BY played_at DESC
  - LIMIT 10 OFFSET (ページ番号 - 1) × 10
  ↓
各セッションを以下の形式で表示:

┌─────────────────────────────────┐
│ 2026/02/20  地理 / 初級  3/5問正解  ▼ │
├─────────────────────────────────┤
│ （折りたたみ: タップで展開）           │
│  問題1: 北海道の県庁所在地は？  ✅     │
│  問題2: 大阪の...              ❌     │
│  正解: たこ焼き                       │
│  解説: たこ焼きは...                  │
│  ...                                 │
└─────────────────────────────────┘
```

### 折りたたみ展開時のデータ取得

```
セッションの▼をタップ:
  ↓
quizzes + answers テーブルを取得（WHERE session_id = そのセッションのID）
  ↓
全問題と回答・解説を表示
```

### ページネーション

```
← 前のページ  [1] [2] [3] ... [10]  次のページ →

- 現在のページはハイライト
- 前のページ/次のページがない場合は非活性
```

### データがない場合

- 「まだクイズを回答していません。トップページからクイズに挑戦してみましょう！」を表示

### アクセス制御

- 未ログインユーザー → ログイン画面にリダイレクト

---

## 8. 達成状況画面（/achievement）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| 日本地図（SVG） | 地図 | トップ画面と同じ色付き地図 |
| 制覇状況 | テキスト + 進捗バー | 「47都道府県中 ○個クリア」 |
| 難易度別の制覇数 | テキスト | 初級: ○/47、中級: ○/47、上級: ○/47 |
| 総回答数 | テキスト | 全セッションの問題数合計 |
| 全体正答率 | テキスト + 進捗バー | 正解数 ÷ 総回答数 × 100 |
| ジャンル別正答率 | テキスト + 進捗バー | 地理: ○%、観光名所: ○%、グルメ: ○% |

### 処理フロー

```
画面表示時:
  ↓
スケルトン表示
  ↓
以下のデータを並行して取得:

1. prefecture_progress テーブル（WHERE user_id = ログインユーザー）
   → 制覇済み都道府県数、難易度別の制覇数、地図の色付けデータ

2. answers テーブル（WHERE user_id = ログインユーザー）
   → 総回答数、正解数（全体正答率の計算用）

3. answers + quizzes テーブル（JOIN）
   → ジャンル別の正解数と回答数（ジャンル別正答率の計算用）
  ↓
各数値を計算して表示
```

### 制覇の判定基準

```
「クリア」= その都道府県でいずれかの難易度で正解したことがある
  → prefecture_progress にレコードが存在する = クリア済み
```

### データがない場合

- 制覇状況: 「0 / 47」、進捗バー 0%
- 正答率: 「まだ回答がありません」

### アクセス制御

- 未ログインユーザー → ログイン画面にリダイレクト

---

## 9. 設定画面（/settings）

### 画面要素

| 要素 | 種類 | 備考 |
|------|------|------|
| 現在のパスワード | パスワード入力 | type="password" |
| 新しいパスワード | パスワード入力 | type="password" |
| 新しいパスワード（確認） | パスワード入力 | type="password" |
| 「パスワードを変更」ボタン | ボタン | |
| 「アカウントを削除」ボタン | ボタン（赤） | 危険操作 |

### パスワード変更

#### バリデーション

| 項目 | ルール | エラーメッセージ |
|------|--------|-----------------|
| 現在のパスワード | 空欄不可 | 「現在のパスワードを入力してください」 |
| 新しいパスワード | 空欄不可 | 「新しいパスワードを入力してください」 |
| 新しいパスワード | 8文字未満 | 「パスワードは8文字以上で入力してください」 |
| 新しいパスワード（確認） | 新しいパスワードと不一致 | 「パスワードが一致しません」 |

#### 処理フロー

```
ユーザーが情報を入力して「パスワードを変更」を押す
  ↓
入力バリデーション
  ↓ OKなら
Supabase Auth: updateUser({ password: 新しいパスワード }) を呼び出す
  ↓
【成功】→ 「パスワードを変更しました」を表示
【失敗】→ 「パスワードの変更に失敗しました」を表示
```

### アカウント削除

#### 処理フロー

```
ユーザーが「アカウントを削除」を押す
  ↓
確認ダイアログを表示:「本当に削除しますか？この操作は取り消せません。」
  → [削除する] [キャンセル]
  ↓
「キャンセル」→ 何もしない
「削除する」→ 処理を実行
  ↓
Supabase: ユーザーを削除
  ↓
CASCADE設定により以下のデータが自動削除される:
  - users レコード
  - quiz_sessions（user_id で紐づく全レコード）
  - quizzes（session_id 経由で全レコード）
  - answers（user_id で紐づく全レコード）
  - prefecture_progress（user_id で紐づく全レコード）
  ↓
【成功】→ ログイン画面にリダイレクト
【失敗】→ 「アカウントの削除に失敗しました」を表示
```

### アクセス制御

- 未ログインユーザー → ログイン画面にリダイレクト

---

## 10. 共通機能

### 10.1 ヘッダー / ナビゲーション

#### PC版（768px以上）

```
[JapanMaster（ロゴ）]    [回答履歴] [達成状況] [設定] [ログアウト]
```

#### スマートフォン版（767px以下）

```
[JapanMaster（ロゴ）]                              [≡]
```

ハンバーガーメニュー（≡）タップで以下を表示:
- 回答履歴 → /history
- 達成状況 → /achievement
- 設定 → /settings
- ログアウト

#### ログアウト処理

```
「ログアウト」をタップ
  ↓
確認ダイアログ:「ログアウトしますか？」→ [はい] [いいえ]
  ↓
「いいえ」→ 何もしない
「はい」→ Supabase Auth: signOut() を呼び出す
  ↓
ログイン画面（/login）にリダイレクト
```

#### ヘッダーの表示ルール

| 画面 | ヘッダー表示 |
|------|-------------|
| ログイン画面 | 非表示 |
| 新規登録画面 | 非表示 |
| パスワードリセット画面 | 非表示 |
| それ以外の全画面 | 表示 |

### 10.2 認証ガード（全画面共通）

```
ページ表示時:
  ↓
Supabase Auth: getSession() でログイン状態を確認
  ↓
【ログイン済み + 認証不要ページ（login, register, reset-password）】
  → トップ画面にリダイレクト
【未ログイン + 認証必要ページ（上記以外）】
  → ログイン画面にリダイレクト
【それ以外】
  → そのまま画面を表示
```

### 10.3 ローディング表示

| 場面 | 表示方法 |
|------|---------|
| クイズ生成中 | 画面全体に「クイズを生成中です...」+ スピナーアニメーション |
| ページ遷移中 | 画面上部にプログレスバー |
| データ取得中（履歴・達成状況） | スケルトン表示（グレーの枠が点滅） |

### 10.4 エラー画面

| HTTP状態 | 表示内容 | ボタン |
|----------|---------|--------|
| 404 | 「ページが見つかりません」 | 「トップに戻る」→ / |
| 500 | 「サーバーでエラーが発生しました。時間をおいて再度お試しください」 | 「トップに戻る」→ / |
| ネットワークエラー | 「通信に失敗しました。ネットワーク接続を確認してください」 | 「再読み込み」→ ページリロード |

### 10.5 広告スペース

| 位置 | 仕様 |
|------|------|
| 画面下部固定バナー | 全画面共通。高さ50px〜90pxの枠を確保。フェーズ1では「広告スペース」とだけ表示 |
| 結果画面 | 全問一覧の下に追加の広告枠を配置 |

---

## 11. データの流れ一覧

各操作でどのテーブルを読み書きするかの一覧。

| 操作 | 読み取り（SELECT） | 書き込み（INSERT/UPDATE） |
|------|-------------------|--------------------------|
| 新規登録 | - | users |
| ログイン | - | -（Supabase Auth内部で処理） |
| トップ画面表示 | prefecture_progress | - |
| ゲームスタート | prefecture_progress, quiz_sessions | quiz_sessions, quizzes |
| 回答する | - | answers |
| 5問終了 | - | quiz_sessions（score更新）, prefecture_progress |
| 結果画面表示 | quiz_sessions, quizzes, answers | - |
| 回答履歴表示 | quiz_sessions, quizzes, answers | - |
| 達成状況表示 | prefecture_progress, answers, quizzes | - |
| パスワード変更 | - | -（Supabase Auth内部で処理） |
| アカウント削除 | - | users（CASCADE削除） |
