# APIキー漏洩調査報告書

- **調査日**: 2026年2月26日
- **対象プロジェクト**: template-a-quiz-studio
- **報告者**: 開発担当
- **対象キー**: Gemini APIキー（`GEMINI_API_KEY`）

---

## 1. 調査の背景

Vercelへのデプロイ後、Gemini APIキーの漏洩が指摘されたため、原因の特定と再発防止のための調査を実施しました。

---

## 2. 調査した項目と結果

以下の6つの観点から、APIキーが外部に漏洩した経路を調査しました。

### 2-1. Gitの履歴（過去のコミット全件）

| チェック内容 | 結果 |
|---|---|
| `.env.local` がコミットされた履歴 | **なし（問題なし）** |
| ソースコードにAPIキーの値がハードコードされた履歴 | **なし（問題なし）** |
| コミットメッセージやPR本文にAPIキーの値が記載された履歴 | **なし（問題なし）** |
| GitHub IssueにAPIキーの値が記載された履歴 | **なし（問題なし）** |

**結論: Gitの履歴経由での漏洩はありません。**

### 2-2. ソースコードの実装

| チェック内容 | 結果 |
|---|---|
| `GEMINI_API_KEY` の使用箇所 | `src/lib/gemini.ts`（サーバー側のみ） |
| `NEXT_PUBLIC_` プレフィックスの誤用 | **なし（問題なし）** |
| クライアント（ブラウザ）側コンポーネントでのAPIキー参照 | **なし（問題なし）** |
| APIレスポンスにAPIキーが含まれるケース | **なし（問題なし）** |

**結論: コードの実装に問題はなく、APIキーはサーバー側でのみ使用されています。**

### 2-3. Next.jsの設定

| チェック内容 | 結果 |
|---|---|
| `next.config.ts` でAPIキーを公開する設定 | **なし（問題なし）** |
| `NEXT_PUBLIC_` 付きの秘密キー定義 | **なし（問題なし）** |

**結論: Next.jsの設定に問題はありません。**

### 2-4. Vercelの環境変数設定

| 変数名 | 設定 | 判定 |
|---|---|---|
| `NEXT_PUBLIC_SUPABASE_URL` | All Environments | 問題なし（公開前提の値） |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | All Environments | 問題なし（RLSで保護される公開キー） |
| `GEMINI_API_KEY` | All Environments | **問題なし（`NEXT_PUBLIC_` なし = ブラウザに露出しない）** |

**結論: Vercelの環境変数設定は正しく、ブラウザへの露出はありません。**

### 2-5. GitHubリポジトリの公開設定

| チェック内容 | 結果 |
|---|---|
| リポジトリの公開設定 | **Public（公開）** |
| URL | https://github.com/arigatosun-bootcamp/template-a-quiz-studio |

**注意: リポジトリがPublic（世界中の誰でもコードを閲覧可能）です。**
現時点ではAPIキーの値はコードに含まれていないため直接的な漏洩はありませんが、誤ってキーをコミットした場合に即座に全世界に公開されるリスクがあります。

### 2-6. ローカル環境の調査

| チェック内容 | 結果 |
|---|---|
| `.claude/logs/`（Claude Codeの会話ログ） | **APIキーの実際の値が6ファイル・19箇所で平文記録されている** |
| `.claude/logs/` のGitコミット状況 | 未コミット（Gitにはまだ含まれていない） |
| `.claude/logs/` の `.gitignore` 設定 | **除外されていない（危険）** |

**重大なリスク: `.claude/logs/` にAPIキーの実際の値が平文で保存されています。**

過去のClaude Codeとの会話で `.env.local` の設定をやり取りした際に、キーの値がログファイルに記録されました。現在はGitにコミットされていませんが、`.gitignore` で除外されていないため、`git add .` を実行すると**Publicリポジトリに公開されてしまう危険があります。**

---

## 3. 調査結論

**今回の調査では、Gemini APIキーが外部に実際に漏洩した明確な経路は発見されませんでした。**

コード、Git履歴、Vercel設定のいずれも正しく設定されており、APIキーがブラウザやGitHub上で公開された形跡はありません。

---

## 4. 発見されたリスク（対応が必要）

### リスク1: `.claude/logs/` にAPIキーが平文保存（緊急度：高）

| 項目 | 内容 |
|---|---|
| 問題 | Claude Codeの会話ログにGemini APIキーの実際の値が平文で記録されている |
| 該当ファイル数 | 6ファイル・19箇所 |
| 現状 | Gitには未コミット（外部には漏れていない） |
| 危険性 | `git add .` で誤ってコミットするとPublicリポジトリで全世界に公開される |
| **対策** | **`.gitignore` に `.claude/logs/` を追加し、ログファイルを削除する** |

### リスク2: GitHubリポジトリがPublic（緊急度：中）

| 項目 | 内容 |
|---|---|
| 問題 | リポジトリが公開設定になっており、誰でもコードを閲覧可能 |
| 現状 | コードにAPIキーは含まれていないため直接的な漏洩はない |
| 危険性 | 今後の作業で誤ってキーをコミットした場合、即座に世界中に公開される |
| **対策** | **業務用途であればPrivate（非公開）への変更を推奨** |

### リスク3: `.gitignore` の除外設定が一部削除されている（緊急度：中）

| 項目 | 内容 |
|---|---|
| 問題 | コミット `0c7f57c` で `.claude/logs/` の除外設定が `.gitignore` から削除された |
| 対策 | **`.gitignore` に `.claude/logs/` を再追加する** |

---

## 5. 推奨する対応アクション

### 即時対応（開発担当で実施可能）

1. `.gitignore` に `.claude/logs/` と `.claude/logs.zip` を追加
2. ローカルの `.claude/logs/` 内のファイルを削除（旧キーの平文記録を消去）
3. Vercelの `GEMINI_API_KEY` の値を新しいキーに更新（未実施の場合）

### 上司にご確認いただきたい事項

1. **漏洩の検知方法**: Gemini APIキーの漏洩はどのように検知されたか（Google Cloudからの通知メール、APIの不正使用ログ、その他）
2. **Google Cloud Console**: APIキーの使用状況ログに不審なアクセスがあるかの確認
3. **リポジトリの公開設定**: 業務用途としてPublic（公開）のままで問題ないか、Private（非公開）に変更すべきか
4. **旧キーの無効化**: 漏洩が指摘された旧キーが確実に無効化されているかの確認

---

## 6. 再発防止策

| 対策 | 内容 |
|---|---|
| `.gitignore` の徹底 | `.env.local`、`.claude/logs/` を必ず除外する |
| コミット前の確認 | `git add .` ではなく `git add ファイル名` で個別にステージングする |
| `NEXT_PUBLIC_` の理解 | 秘密キーには絶対に `NEXT_PUBLIC_` プレフィックスをつけない |
| リポジトリのPrivate化検討 | 万が一の誤コミットに備え、非公開設定を推奨 |
| APIキーのローテーション | 漏洩が疑われた場合は即座にキーを再発行する |
