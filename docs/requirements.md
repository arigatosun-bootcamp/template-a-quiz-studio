# JapanMaster ～日本制覇への道～ 要件定義書

## 1. アプリ概要

| 項目 | 内容 |
|------|------|
| アプリ名 | JapanMaster |
| サブタイトル | 日本制覇への道 |
| 概要 | AIが日本に関するクイズを自動生成し、ユーザーが回答しながら日本の知識を深めるWebアプリ |
| デザイン | 和風（紺#1B2A4A・朱色#C53D43・金#C4A962・白〜生成り#FAF8F5・灰#6B7280） |
| 対応デバイス | PC＋スマートフォン（レスポンシブデザイン） |
| 対応言語 | フェーズ1: 日本語のみ / フェーズ2: 英語対応（将来） |

## 2. 技術スタック

| 技術 | 用途 |
|------|------|
| Next.js (TypeScript) | フロントエンド＋API |
| Supabase | データベース・認証 |
| Claude API | クイズ自動生成 |
| Vitest | テスト |
| ESLint | コード品質チェック |

## 3. ユーザー認証

| 項目 | 仕様 |
|------|------|
| 公開範囲 | 一般公開（誰でも登録可能） |
| ログイン方法 | メールアドレス＆パスワード / Googleアカウント |
| ログイン要否 | 必須（ログインしないとアプリを利用できない） |
| ユーザー情報 | メールアドレスのみ（ニックネーム不要） |
| パスワードリセット | Supabaseの仕組みを利用（メール送信→再設定） |
| メール確認 | 新規登録後に認証メールを送信。メール内のリンクをクリックして初めて利用可能（スパム防止） |
| アカウント統合 | 同じメールアドレスでメール登録とGoogleログインを行った場合、自動的に同一アカウントとして統合する |

## 4. クイズ機能

### 4.1 基本仕様

| 項目 | 仕様 |
|------|------|
| 出題数 | 1回あたり5問 |
| 回答形式 | 3択（選択式） |
| 制限時間 | なし（じっくり考えられる） |
| 生成方法 | AIが自動生成 |
| 都道府県紐づけ | すべての問題を必ず1つの都道府県に紐づける |

### 4.2 ジャンル（3種類）

| ジャンル | 内容例 |
|----------|--------|
| 地理 | 都道府県・県庁所在地・地形 |
| 観光名所 | 名所・世界遺産・名勝 |
| ご当地グルメ | 郷土料理・名産品・B級グルメ |

### 4.3 難易度（3段階）

難易度は「知名度」「問題形式」「地域の有名度」を組み合わせて決定する。
AIへの指示で難易度のニュアンスを伝え、適切なレベルの問題を生成させる。

| 難易度 | 基準 |
|--------|------|
| 初級 | 誰でも知っている基本知識。有名な都道府県が中心。選択肢を見ればわかるレベル |
| 中級 | 旅行好きなら知っている知識。やや細かい内容。少し考える必要があるレベル |
| 上級 | 現地の人や詳しい人向け。マニアックな知識。知識がないと答えられないレベル |

### 4.4 クイズの生成と出題ロジック

- ゲームスタート時に5問まとめて生成する（ローディングは最初の1回のみ）
- プログラムがユーザーの回答履歴から未正解の都道府県を洗い出し、ランダムに5県を選ぶ（全県正解済みの場合は全47県からランダム）
- 5問 = 5県（すべて別の県）で出題する
- 各県を指定してAIに問題を生成させる

AIが1問ごとに返すデータ:
```
{
  question:    "問題文"
  choices:     ["選択肢A", "選択肢B", "選択肢C"]
  answer:      "正解の選択肢"
  explanation: "解説文"
  prefecture:  "都道府県名"
}
```

### 4.5 クイズ中の体験

- 画面上部に進捗を表示する（「問題 3 / 5」）
- 1問答えるたびに即座に正解/不正解を表示する
- 回答の流れ: 選択肢をタップ（ハイライト）→「回答する」ボタンで確定 → 正解/不正解＋解説が表示される
- 不正解の場合は正解の選択肢＋解説を表示する
- 解説表示後、「次の問題へ」ボタンをタップして次に進む（自動遷移しない。ユーザーが自分のペースで読める）
- 5問目の回答後は「次の問題へ」ボタンが「結果を見る」に変わる
- AIには問題・選択肢・正解・解説をまとめて生成してもらう

### 4.6 AI利用制限

| 項目 | 仕様 |
|------|------|
| 1日の利用上限 | ユーザー1人あたり1日20回まで（100問/日） |
| 上限到達時の表示 | 「本日の利用上限に達しました。明日またお楽しみください」 |
| リセット時刻 | 毎日0:00（日本時間）にリセット |

### 4.7 AI生成のエラー処理

- AIが問題生成に失敗した場合、自動で最大3回リトライする
- 3回リトライしても失敗した場合「問題の生成に失敗しました。もう一度お試しください」と表示し再試行ボタンを出す

## 5. 日本地図

| 項目 | 仕様 |
|------|------|
| 表示位置 | トップ画面に常時表示 |
| 形式 | SVG形式（47都道府県を個別に色制御） |
| タップ動作 | 地図全体をタップ → 達成状況画面へ遷移 |
| 色付けルール | 正解した都道府県に色がつく |
| 色のレベルアップ | 同じ県で上の難易度に正解すると色が変化（上書き） |

### 色付けルール詳細

| 状態 | 色 |
|------|-----|
| 未回答 | グレー（デフォルト） |
| 初級で正解 | 薄い緑（若草色） |
| 中級で正解 | 緑（抹茶色） |
| 上級で正解 | 深い緑 |

## 6. 画面一覧と仕様

### 6.1 画面一覧（全9画面）

| # | 画面名 | 概要 |
|---|--------|------|
| 1 | ログイン画面 | メール&PW or Googleでログイン |
| 2 | 新規登録画面 | アカウント作成 |
| 3 | パスワードリセット画面 | メール送信→PW再設定 |
| 4 | トップ画面 | 日本地図 + ジャンル→難易度→スタート |
| 5 | クイズ画面 | 問題＋3択（5問、1問ごとに結果＋解説） |
| 6 | 結果画面 | 正解数＋全問振り返り＋解説＋広告 |
| 7 | 回答履歴画面 | 過去の全問題と解説（ページネーション＋折りたたみ） |
| 8 | 達成状況画面 | 制覇率・難易度別進捗・正答率・ジャンル別正答率 |
| 9 | 設定画面 | パスワード変更・アカウント削除 |

### 6.2 ログイン画面・新規登録画面の詳細

ビジュアル型レイアウト（和風の背景画像＋白い枠のフォーム）。

ログイン画面:
- メールアドレス入力欄
- パスワード入力欄
- 「ログイン」ボタン（朱色）
- 「Googleでログイン」ボタン
- 「パスワードを忘れた方はこちら」リンク
- 「新規登録はこちら」リンク

新規登録画面:
- メールアドレス入力欄
- パスワード入力欄
- パスワード確認入力欄
- 「利用規約・プライバシーポリシーに同意する」チェックボックス（同意しないと登録不可）
- 「新規登録」ボタン（朱色）
- 「Googleで登録」ボタン
- 「ログインはこちら」リンク

新規登録後の流れ:
- 「確認メールを送信しました。メール内のリンクをクリックしてください」と表示
- メール内リンクをクリック → ログイン画面に遷移（「認証が完了しました。ログインしてください」と表示）

### 6.3 トップ画面の詳細

トップ画面ではジャンル・難易度をステップ形式で選択する（同じ画面内で段階的に表示）。

```
ステップ1: ジャンルを選択 → [地理] [観光名所] [グルメ]
ステップ2: 難易度を選択  → [初級] [中級] [上級]
ステップ3: スタートボタン表示 → [ゲームスタート！]
```

選び直しも可能（ジャンルをタップで再選択）。

### 6.4 結果画面の詳細

- 5問中の正解数を大きく表示
- 正解数に応じたメッセージを表示:
  - 5問正解:「パーフェクト！日本マスターへの道を順調に進んでいます！」
  - 3〜4問:「いい調子です！もう少しで全問正解！」
  - 1〜2問:「次はもっと上を目指しましょう！」
  - 0問:「ドンマイ！挑戦することが大事です！」
- 全問の正解/不正解を上から順に一覧で表示（折りたたみなし）
- 不正解の問題は解説を再表示
- 「同じ条件でもう一度」ボタン＋「トップに戻る」ボタン
- 広告を表示

### 6.5 回答履歴画面の詳細

- 過去のクイズ結果を新しい順に一覧表示（日付・ジャンル・難易度・正解数）
- 各回を折りたたみ式で展開 → 全問題と解説が見れる
- 1ページ10回分表示（ページネーション）
- 回答が蓄積されると「日本の教科書」としての役割を果たす

### 6.6 達成状況画面の詳細

以下の情報を表示する：

- 日本地図（トップ画面と同じ色付き地図を表示）
- 都道府県制覇状況（47都道府県中○個クリア + 進捗バー）
- 難易度別の制覇数（初級: ○/47、中級: ○/47、上級: ○/47）
- 総回答数と全体正答率
- ジャンル別正答率（地理: ○%、観光名所: ○%、グルメ: ○%）

### 6.7 設定画面の詳細

- パスワード変更（現在のパスワード＋新しいパスワードを入力して変更）
- アカウント削除（確認ダイアログで「本当に削除しますか？」を表示してから実行）
- アカウント削除時はユーザーに紐づくすべてのデータ（回答履歴・達成状況）も削除する

## 7. ナビゲーション

### PC版

ヘッダーに以下を表示：
```
[JapanMaster]    [回答履歴] [達成状況] [設定] [ログアウト]
```

### スマートフォン版

ヘッダーにタイトル「JapanMaster」を表示し、右側にハンバーガーメニュー（≡）を配置。
```
[JapanMaster]                [≡]
```

ハンバーガーメニュー内に以下を格納：
- 回答履歴
- 達成状況
- 設定
- ログアウト

### レスポンシブ切り替え

- 768px以上: PC表示（ヘッダーにボタン並ぶ）
- 767px以下: スマホ表示（ハンバーガーメニュー）

### ログアウト

- ログアウト時は確認ダイアログを表示（「ログアウトしますか？」→ [はい] [いいえ]）
- ログアウト後はログイン画面に遷移する

### 回答履歴への導線（2つ）

1. ヘッダー（PC）/ ハンバーガーメニュー（スマホ）
2. トップ画面下部の「回答履歴を見る」ボタン

### 対応ブラウザ

Chrome / Safari / Firefox / Edge

## 8. 広告

| 項目 | 仕様 |
|------|------|
| 配置1 | 画面下部に固定バナー（全画面共通） |
| 配置2 | 結果画面にも広告表示 |
| 導入時期 | アプリ本体完成後に広告サービス（Google AdSense等）に申請 |
| 初期対応 | 広告表示スペースのみ確保しておく |

## 9. データベース設計（概要）

### 必要なテーブル

| テーブル名 | 保存内容 |
|-----------|---------|
| users | ユーザー情報（ID, メールアドレス, 作成日） |
| quizzes | クイズ問題（ID, 問題文, 選択肢3つ, 正解, 解説, ジャンル, 難易度, 都道府県） |
| answers | 回答履歴（ID, ユーザーID, クイズID, 選んだ答え, 正解したか, 回答日） |
| quiz_sessions | クイズセッション（ID, ユーザーID, ジャンル, 難易度, 正解数, 実施日） |
| prefecture_progress | 都道府県の達成状況（ユーザーID, 都道府県, 最高クリア難易度） |

## 10. セキュリティ

| 項目 | 仕様 |
|------|------|
| パスワード条件 | 8文字以上 |
| ログイン失敗制限 | 5回連続失敗で30分間ロック（総当たり攻撃の防止） |
| セッション有効期限 | 7日間（期限切れ後は再ログインが必要） |

## 11. ローディング・エラー画面

### ローディング表示

ユーザーを待たせる処理には必ずローディング表示を出す。

| 場面 | 表示内容 |
|------|---------|
| クイズ生成中 | 「クイズを生成中です...」＋ローディングアニメーション |
| ページ遷移中 | ローディングインジケーター |
| データ取得中（履歴・達成状況） | スケルトン表示（枠だけ先に表示して中身を後から読み込む） |

### エラー画面

| 場面 | 表示内容 |
|------|---------|
| 存在しないページ（404） | 「ページが見つかりません」＋トップに戻るボタン |
| サーバーエラー（500） | 「サーバーでエラーが発生しました。時間をおいて再度お試しください」 |
| ネットワークエラー | 「通信に失敗しました。ネットワーク接続を確認してください」 |

### クイズ中の離脱

| 場面 | 動作 |
|------|------|
| ブラウザを閉じた / 戻るボタンを押した | 途中データは破棄。次回は最初から |
| ネットワーク切断 | エラー表示。回答済みのデータは保存されない |

## 12. プライバシーポリシー・利用規約

| 項目 | 仕様 |
|------|------|
| プライバシーポリシーページ | 収集するデータ（メールアドレス・回答履歴）と利用目的を記載 |
| 利用規約ページ | サービスの利用条件を記載 |
| 同意の取得 | 新規登録画面に「利用規約・プライバシーポリシーに同意する」チェックボックスを設置。同意しないと登録不可 |
| 導線 | ログイン画面・新規登録画面・フッターからリンク |

## 13. デプロイ（公開環境）

| 項目 | 仕様 |
|------|------|
| ホスティング | Vercel（Next.jsとの親和性が最も高い。無料枠あり） |
| ドメイン | Vercelのデフォルトドメイン（xxx.vercel.app）を初期利用。独自ドメインは必要に応じて後日設定 |
| 環境変数 | Supabase接続情報・Claude APIキーはVercelの環境変数に設定（コードに含めない） |

## 14. フェーズ分け

### フェーズ1（今回のスコープ）

- 全画面の実装（9画面 + エラー画面 + プライバシーポリシー・利用規約ページ）
- ユーザー認証（メール&PW + Google）
- AIクイズ生成（日本語）
- 日本地図の色付け
- 回答履歴・達成状況
- レスポンシブデザイン（PC＋スマホ）
- ローディング・エラー表示
- セキュリティ対策
- プライバシーポリシー・利用規約
- 広告スペースの確保
- Vercelへのデプロイ

### フェーズ2（将来対応）

- 英語対応（UI＋クイズ＋解説すべて）
- 言語切り替え機能（メニュー内にいつでも切り替えボタン）
- 広告の実装（AdSense等の申請・導入）
- 独自ドメインの設定

## 15. やらないこと（対象外）

明確に「やらない」と決めた項目の一覧。開発中に「これもあった方がいいのでは？」と迷ったときの判断基準にする。

### ユーザー関連

| やらないこと | 理由 |
|-------------|------|
| マイページ（プロフィール編集・アイコン設定） | 今回はニックネームもアイコンも不要と決めたため。設定画面でPW変更・アカウント削除は対応済み |
| ニックネームの設定 | ランキングやソーシャル機能がないため表示名が不要 |

### クイズ関連

| やらないこと | 理由 |
|-------------|------|
| ユーザーが自分でクイズ問題を作成する機能 | AIが自動生成するのがアプリの核心。ユーザー作成問題は品質管理が困難 |
| 問題のブックマーク（お気に入り）機能 | 回答履歴で過去の問題をすべて振り返れるため、ブックマークは不要 |
| 間違えた問題だけの「復習モード」 | 便利だが、フェーズ1では回答履歴の閲覧で代替する |
| 5問以外の出題数を選べる機能 | 選択肢を増やすと画面設計が複雑になる。まず5問固定で完成させる |
| タイムアタックモード | 「じっくり学べる教科書」というコンセプトと矛盾するため |

### ソーシャル関連

| やらないこと | 理由 |
|-------------|------|
| ランキング機能 | ユーザー間の比較より個人の学習に集中するアプリのため |
| SNSシェア機能 | フェーズ1ではアプリ本体の完成を優先する |
| フレンド機能・対戦機能 | 開発規模が大きくなりすぎる。個人学習アプリとしてまず完成させる |

### コンテンツ関連

| やらないこと | 理由 |
|-------------|------|
| 日本以外の国のクイズ | アプリのコンセプトが「日本制覇」のため対象外 |
| フリーワード検索機能 | クイズ形式での学習に特化するため |
| クイズ以外の学習コンテンツ（読み物・コラム） | クイズの解説が学習コンテンツの役割を果たすため不要 |

### システム関連

| やらないこと | 理由 |
|-------------|------|
| オフライン対応 | AI生成にネット接続が必須のため実現不可 |
| プッシュ通知 | ブラウザの通知は設定が複雑でユーザーにも嫌がられやすい |
| ダークモード | フェーズ1では和風デザイン1種類に集中する |
